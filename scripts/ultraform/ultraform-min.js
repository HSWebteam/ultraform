/**
 * almond 0.2.6 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

//     Underscore.js 1.5.2
//     http://underscorejs.org
//     (c) 2009-2013 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Underscore may be freely distributed under the MIT license.

//     (c) 2010-2011 Jeremy Ashkenas, DocumentCloud Inc.
//     (c) 2011-2013 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Backbone may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://backbonejs.org

var requirejs,require,define;!function(t){function e(t,e){return m.call(t,e)}function n(t,e){var n,i,r,a,s,o,l,u,c,h,d=e&&e.split("/"),f=g.map,p=f&&f["*"]||{};if(t&&"."===t.charAt(0))if(e){for(d=d.slice(0,d.length-1),t=d.concat(t.split("/")),u=0;u<t.length;u+=1)if(h=t[u],"."===h)t.splice(u,1),u-=1;else if(".."===h){if(1===u&&(".."===t[2]||".."===t[0]))break;u>0&&(t.splice(u-1,2),u-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((d||p)&&f){for(n=t.split("/"),u=n.length;u>0;u-=1){if(i=n.slice(0,u).join("/"),d)for(c=d.length;c>0;c-=1)if(r=f[d.slice(0,c).join("/")],r&&(r=r[i])){a=r,s=u;break}if(a)break;!o&&p&&p[i]&&(o=p[i],l=u)}!a&&o&&(a=o,s=l),a&&(n.splice(0,s,a),t=n.join("/"))}return t}function i(e,n){return function(){return c.apply(t,y.call(arguments,0).concat([e,n]))}}function r(t){return function(e){return n(e,t)}}function a(t){return function(e){f[t]=e}}function s(n){if(e(p,n)){var i=p[n];delete p[n],v[n]=!0,u.apply(t,i)}if(!e(f,n)&&!e(v,n))throw new Error("No "+n);return f[n]}function o(t){var e,n=t?t.indexOf("!"):-1;return n>-1&&(e=t.substring(0,n),t=t.substring(n+1,t.length)),[e,t]}function l(t){return function(){return g&&g.config&&g.config[t]||{}}}var u,c,h,d,f={},p={},g={},v={},m=Object.prototype.hasOwnProperty,y=[].slice;h=function(t,e){var i,a=o(t),l=a[0];return t=a[1],l&&(l=n(l,e),i=s(l)),l?t=i&&i.normalize?i.normalize(t,r(e)):n(t,e):(t=n(t,e),a=o(t),l=a[0],t=a[1],l&&(i=s(l))),{f:l?l+"!"+t:t,n:t,pr:l,p:i}},d={require:function(t){return i(t)},exports:function(t){var e=f[t];return"undefined"!=typeof e?e:f[t]={}},module:function(t){return{id:t,uri:"",exports:f[t],config:l(t)}}},u=function(n,r,o,l){var u,c,g,m,y,b,_=[];if(l=l||n,"function"==typeof o){for(r=!r.length&&o.length?["require","exports","module"]:r,y=0;y<r.length;y+=1)if(m=h(r[y],l),c=m.f,"require"===c)_[y]=d.require(n);else if("exports"===c)_[y]=d.exports(n),b=!0;else if("module"===c)u=_[y]=d.module(n);else if(e(f,c)||e(p,c)||e(v,c))_[y]=s(c);else{if(!m.p)throw new Error(n+" missing "+c);m.p.load(m.n,i(l,!0),a(c),{}),_[y]=f[c]}g=o.apply(f[n],_),n&&(u&&u.exports!==t&&u.exports!==f[n]?f[n]=u.exports:g===t&&b||(f[n]=g))}else n&&(f[n]=o)},requirejs=require=c=function(e,n,i,r,a){return"string"==typeof e?d[e]?d[e](n):s(h(e,n).f):(e.splice||(g=e,n.splice?(e=n,n=i,i=null):e=t),n=n||function(){},"function"==typeof i&&(i=r,r=a),r?u(t,e,n,i):setTimeout(function(){u(t,e,n,i)},4),c)},c.config=function(t){return g=t,g.deps&&c(g.deps,g.callback),c},requirejs._defined=f,define=function(t,n,i){n.splice||(i=n,n=[]),e(f,t)||e(p,t)||(p[t]=[t,n,i])},define.amd={jQuery:!0}}(),define("almond",function(){}),define("jquery/jquery-private",["jquery"],function(){return jQuery}),function(){var t=this,e=t._,n={},i=Array.prototype,r=Object.prototype,a=Function.prototype,s=i.push,o=i.slice,l=i.concat,u=r.toString,c=r.hasOwnProperty,h=i.forEach,d=i.map,f=i.reduce,p=i.reduceRight,g=i.filter,v=i.every,m=i.some,y=i.indexOf,b=i.lastIndexOf,_=Array.isArray,w=Object.keys,x=a.bind,$=function(t){return t instanceof $?t:this instanceof $?void(this._wrapped=t):new $(t)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=$),exports._=$):t._=$,$.VERSION="1.5.2";var S=$.each=$.forEach=function(t,e,i){if(null!=t)if(h&&t.forEach===h)t.forEach(e,i);else if(t.length===+t.length){for(var r=0,a=t.length;a>r;r++)if(e.call(i,t[r],r,t)===n)return}else for(var s=$.keys(t),r=0,a=s.length;a>r;r++)if(e.call(i,t[s[r]],s[r],t)===n)return};$.map=$.collect=function(t,e,n){var i=[];return null==t?i:d&&t.map===d?t.map(e,n):(S(t,function(t,r,a){i.push(e.call(n,t,r,a))}),i)};var k="Reduce of empty array with no initial value";$.reduce=$.foldl=$.inject=function(t,e,n,i){var r=arguments.length>2;if(null==t&&(t=[]),f&&t.reduce===f)return i&&(e=$.bind(e,i)),r?t.reduce(e,n):t.reduce(e);if(S(t,function(t,a,s){r?n=e.call(i,n,t,a,s):(n=t,r=!0)}),!r)throw new TypeError(k);return n},$.reduceRight=$.foldr=function(t,e,n,i){var r=arguments.length>2;if(null==t&&(t=[]),p&&t.reduceRight===p)return i&&(e=$.bind(e,i)),r?t.reduceRight(e,n):t.reduceRight(e);var a=t.length;if(a!==+a){var s=$.keys(t);a=s.length}if(S(t,function(o,l,u){l=s?s[--a]:--a,r?n=e.call(i,n,t[l],l,u):(n=t[l],r=!0)}),!r)throw new TypeError(k);return n},$.find=$.detect=function(t,e,n){var i;return E(t,function(t,r,a){return e.call(n,t,r,a)?(i=t,!0):void 0}),i},$.filter=$.select=function(t,e,n){var i=[];return null==t?i:g&&t.filter===g?t.filter(e,n):(S(t,function(t,r,a){e.call(n,t,r,a)&&i.push(t)}),i)},$.reject=function(t,e,n){return $.filter(t,function(t,i,r){return!e.call(n,t,i,r)},n)},$.every=$.all=function(t,e,i){e||(e=$.identity);var r=!0;return null==t?r:v&&t.every===v?t.every(e,i):(S(t,function(t,a,s){return(r=r&&e.call(i,t,a,s))?void 0:n}),!!r)};var E=$.some=$.any=function(t,e,i){e||(e=$.identity);var r=!1;return null==t?r:m&&t.some===m?t.some(e,i):(S(t,function(t,a,s){return r||(r=e.call(i,t,a,s))?n:void 0}),!!r)};$.contains=$.include=function(t,e){return null==t?!1:y&&t.indexOf===y?-1!=t.indexOf(e):E(t,function(t){return t===e})},$.invoke=function(t,e){var n=o.call(arguments,2),i=$.isFunction(e);return $.map(t,function(t){return(i?e:t[e]).apply(t,n)})},$.pluck=function(t,e){return $.map(t,function(t){return t[e]})},$.where=function(t,e,n){return $.isEmpty(e)?n?void 0:[]:$[n?"find":"filter"](t,function(t){for(var n in e)if(e[n]!==t[n])return!1;return!0})},$.findWhere=function(t,e){return $.where(t,e,!0)},$.max=function(t,e,n){if(!e&&$.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.max.apply(Math,t);if(!e&&$.isEmpty(t))return-1/0;var i={computed:-1/0,value:-1/0};return S(t,function(t,r,a){var s=e?e.call(n,t,r,a):t;s>i.computed&&(i={value:t,computed:s})}),i.value},$.min=function(t,e,n){if(!e&&$.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.min.apply(Math,t);if(!e&&$.isEmpty(t))return 1/0;var i={computed:1/0,value:1/0};return S(t,function(t,r,a){var s=e?e.call(n,t,r,a):t;s<i.computed&&(i={value:t,computed:s})}),i.value},$.shuffle=function(t){var e,n=0,i=[];return S(t,function(t){e=$.random(n++),i[n-1]=i[e],i[e]=t}),i},$.sample=function(t,e,n){return arguments.length<2||n?t[$.random(t.length-1)]:$.shuffle(t).slice(0,Math.max(0,e))};var V=function(t){return $.isFunction(t)?t:function(e){return e[t]}};$.sortBy=function(t,e,n){var i=V(e);return $.pluck($.map(t,function(t,e,r){return{value:t,index:e,criteria:i.call(n,t,e,r)}}).sort(function(t,e){var n=t.criteria,i=e.criteria;if(n!==i){if(n>i||void 0===n)return 1;if(i>n||void 0===i)return-1}return t.index-e.index}),"value")};var j=function(t){return function(e,n,i){var r={},a=null==n?$.identity:V(n);return S(e,function(n,s){var o=a.call(i,n,s,e);t(r,o,n)}),r}};$.groupBy=j(function(t,e,n){($.has(t,e)?t[e]:t[e]=[]).push(n)}),$.indexBy=j(function(t,e,n){t[e]=n}),$.countBy=j(function(t,e){$.has(t,e)?t[e]++:t[e]=1}),$.sortedIndex=function(t,e,n,i){n=null==n?$.identity:V(n);for(var r=n.call(i,e),a=0,s=t.length;s>a;){var o=a+s>>>1;n.call(i,t[o])<r?a=o+1:s=o}return a},$.toArray=function(t){return t?$.isArray(t)?o.call(t):t.length===+t.length?$.map(t,$.identity):$.values(t):[]},$.size=function(t){return null==t?0:t.length===+t.length?t.length:$.keys(t).length},$.first=$.head=$.take=function(t,e,n){return null==t?void 0:null==e||n?t[0]:o.call(t,0,e)},$.initial=function(t,e,n){return o.call(t,0,t.length-(null==e||n?1:e))},$.last=function(t,e,n){return null==t?void 0:null==e||n?t[t.length-1]:o.call(t,Math.max(t.length-e,0))},$.rest=$.tail=$.drop=function(t,e,n){return o.call(t,null==e||n?1:e)},$.compact=function(t){return $.filter(t,$.identity)};var C=function(t,e,n){return e&&$.every(t,$.isArray)?l.apply(n,t):(S(t,function(t){$.isArray(t)||$.isArguments(t)?e?s.apply(n,t):C(t,e,n):n.push(t)}),n)};$.flatten=function(t,e){return C(t,e,[])},$.without=function(t){return $.difference(t,o.call(arguments,1))},$.uniq=$.unique=function(t,e,n,i){$.isFunction(e)&&(i=n,n=e,e=!1);var r=n?$.map(t,n,i):t,a=[],s=[];return S(r,function(n,i){(e?i&&s[s.length-1]===n:$.contains(s,n))||(s.push(n),a.push(t[i]))}),a},$.union=function(){return $.uniq($.flatten(arguments,!0))},$.intersection=function(t){var e=o.call(arguments,1);return $.filter($.uniq(t),function(t){return $.every(e,function(e){return $.indexOf(e,t)>=0})})},$.difference=function(t){var e=l.apply(i,o.call(arguments,1));return $.filter(t,function(t){return!$.contains(e,t)})},$.zip=function(){for(var t=$.max($.pluck(arguments,"length").concat(0)),e=new Array(t),n=0;t>n;n++)e[n]=$.pluck(arguments,""+n);return e},$.object=function(t,e){if(null==t)return{};for(var n={},i=0,r=t.length;r>i;i++)e?n[t[i]]=e[i]:n[t[i][0]]=t[i][1];return n},$.indexOf=function(t,e,n){if(null==t)return-1;var i=0,r=t.length;if(n){if("number"!=typeof n)return i=$.sortedIndex(t,e),t[i]===e?i:-1;i=0>n?Math.max(0,r+n):n}if(y&&t.indexOf===y)return t.indexOf(e,n);for(;r>i;i++)if(t[i]===e)return i;return-1},$.lastIndexOf=function(t,e,n){if(null==t)return-1;var i=null!=n;if(b&&t.lastIndexOf===b)return i?t.lastIndexOf(e,n):t.lastIndexOf(e);for(var r=i?n:t.length;r--;)if(t[r]===e)return r;return-1},$.range=function(t,e,n){arguments.length<=1&&(e=t||0,t=0),n=arguments[2]||1;for(var i=Math.max(Math.ceil((e-t)/n),0),r=0,a=new Array(i);i>r;)a[r++]=t,t+=n;return a};var T=function(){};$.bind=function(t,e){var n,i;if(x&&t.bind===x)return x.apply(t,o.call(arguments,1));if(!$.isFunction(t))throw new TypeError;return n=o.call(arguments,2),i=function(){if(!(this instanceof i))return t.apply(e,n.concat(o.call(arguments)));T.prototype=t.prototype;var r=new T;T.prototype=null;var a=t.apply(r,n.concat(o.call(arguments)));return Object(a)===a?a:r}},$.partial=function(t){var e=o.call(arguments,1);return function(){return t.apply(this,e.concat(o.call(arguments)))}},$.bindAll=function(t){var e=o.call(arguments,1);if(0===e.length)throw new Error("bindAll must be passed function names");return S(e,function(e){t[e]=$.bind(t[e],t)}),t},$.memoize=function(t,e){var n={};return e||(e=$.identity),function(){var i=e.apply(this,arguments);return $.has(n,i)?n[i]:n[i]=t.apply(this,arguments)}},$.delay=function(t,e){var n=o.call(arguments,2);return setTimeout(function(){return t.apply(null,n)},e)},$.defer=function(t){return $.delay.apply($,[t,1].concat(o.call(arguments,1)))},$.throttle=function(t,e,n){var i,r,a,s=null,o=0;n||(n={});var l=function(){o=n.leading===!1?0:new Date,s=null,a=t.apply(i,r)};return function(){var u=new Date;o||n.leading!==!1||(o=u);var c=e-(u-o);return i=this,r=arguments,0>=c?(clearTimeout(s),s=null,o=u,a=t.apply(i,r)):s||n.trailing===!1||(s=setTimeout(l,c)),a}},$.debounce=function(t,e,n){var i,r,a,s,o;return function(){a=this,r=arguments,s=new Date;var l=function(){var u=new Date-s;e>u?i=setTimeout(l,e-u):(i=null,n||(o=t.apply(a,r)))},u=n&&!i;return i||(i=setTimeout(l,e)),u&&(o=t.apply(a,r)),o}},$.once=function(t){var e,n=!1;return function(){return n?e:(n=!0,e=t.apply(this,arguments),t=null,e)}},$.wrap=function(t,e){return function(){var n=[t];return s.apply(n,arguments),e.apply(this,n)}},$.compose=function(){var t=arguments;return function(){for(var e=arguments,n=t.length-1;n>=0;n--)e=[t[n].apply(this,e)];return e[0]}},$.after=function(t,e){return function(){return--t<1?e.apply(this,arguments):void 0}},$.keys=w||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var n in t)$.has(t,n)&&e.push(n);return e},$.values=function(t){for(var e=$.keys(t),n=e.length,i=new Array(n),r=0;n>r;r++)i[r]=t[e[r]];return i},$.pairs=function(t){for(var e=$.keys(t),n=e.length,i=new Array(n),r=0;n>r;r++)i[r]=[e[r],t[e[r]]];return i},$.invert=function(t){for(var e={},n=$.keys(t),i=0,r=n.length;r>i;i++)e[t[n[i]]]=n[i];return e},$.functions=$.methods=function(t){var e=[];for(var n in t)$.isFunction(t[n])&&e.push(n);return e.sort()},$.extend=function(t){return S(o.call(arguments,1),function(e){if(e)for(var n in e)t[n]=e[n]}),t},$.pick=function(t){var e={},n=l.apply(i,o.call(arguments,1));return S(n,function(n){n in t&&(e[n]=t[n])}),e},$.omit=function(t){var e={},n=l.apply(i,o.call(arguments,1));for(var r in t)$.contains(n,r)||(e[r]=t[r]);return e},$.defaults=function(t){return S(o.call(arguments,1),function(e){if(e)for(var n in e)void 0===t[n]&&(t[n]=e[n])}),t},$.clone=function(t){return $.isObject(t)?$.isArray(t)?t.slice():$.extend({},t):t},$.tap=function(t,e){return e(t),t};var O=function(t,e,n,i){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return t===e;t instanceof $&&(t=t._wrapped),e instanceof $&&(e=e._wrapped);var r=u.call(t);if(r!=u.call(e))return!1;switch(r){case"[object String]":return t==String(e);case"[object Number]":return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object RegExp]":return t.source==e.source&&t.global==e.global&&t.multiline==e.multiline&&t.ignoreCase==e.ignoreCase}if("object"!=typeof t||"object"!=typeof e)return!1;for(var a=n.length;a--;)if(n[a]==t)return i[a]==e;var s=t.constructor,o=e.constructor;if(s!==o&&!($.isFunction(s)&&s instanceof s&&$.isFunction(o)&&o instanceof o))return!1;n.push(t),i.push(e);var l=0,c=!0;if("[object Array]"==r){if(l=t.length,c=l==e.length)for(;l--&&(c=O(t[l],e[l],n,i)););}else{for(var h in t)if($.has(t,h)&&(l++,!(c=$.has(e,h)&&O(t[h],e[h],n,i))))break;if(c){for(h in e)if($.has(e,h)&&!l--)break;c=!l}}return n.pop(),i.pop(),c};$.isEqual=function(t,e){return O(t,e,[],[])},$.isEmpty=function(t){if(null==t)return!0;if($.isArray(t)||$.isString(t))return 0===t.length;for(var e in t)if($.has(t,e))return!1;return!0},$.isElement=function(t){return!(!t||1!==t.nodeType)},$.isArray=_||function(t){return"[object Array]"==u.call(t)},$.isObject=function(t){return t===Object(t)},S(["Arguments","Function","String","Number","Date","RegExp"],function(t){$["is"+t]=function(e){return u.call(e)=="[object "+t+"]"}}),$.isArguments(arguments)||($.isArguments=function(t){return!(!t||!$.has(t,"callee"))}),"function"!=typeof/./&&($.isFunction=function(t){return"function"==typeof t}),$.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},$.isNaN=function(t){return $.isNumber(t)&&t!=+t},$.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==u.call(t)},$.isNull=function(t){return null===t},$.isUndefined=function(t){return void 0===t},$.has=function(t,e){return c.call(t,e)},$.noConflict=function(){return t._=e,this},$.identity=function(t){return t},$.times=function(t,e,n){for(var i=Array(Math.max(0,t)),r=0;t>r;r++)i[r]=e.call(n,r);return i},$.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))};var A={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};A.unescape=$.invert(A.escape);var M={escape:new RegExp("["+$.keys(A.escape).join("")+"]","g"),unescape:new RegExp("("+$.keys(A.unescape).join("|")+")","g")};$.each(["escape","unescape"],function(t){$[t]=function(e){return null==e?"":(""+e).replace(M[t],function(e){return A[t][e]})}}),$.result=function(t,e){if(null==t)return void 0;var n=t[e];return $.isFunction(n)?n.call(t):n},$.mixin=function(t){S($.functions(t),function(e){var n=$[e]=t[e];$.prototype[e]=function(){var t=[this._wrapped];return s.apply(t,arguments),z.call(this,n.apply($,t))}})};var q=0;$.uniqueId=function(t){var e=++q+"";return t?t+e:e},$.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var I=/(.)^/,N={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},R=/\\|'|\r|\n|\t|\u2028|\u2029/g;$.template=function(t,e,n){var i;n=$.defaults({},n,$.templateSettings);var r=new RegExp([(n.escape||I).source,(n.interpolate||I).source,(n.evaluate||I).source].join("|")+"|$","g"),a=0,s="__p+='";t.replace(r,function(e,n,i,r,o){return s+=t.slice(a,o).replace(R,function(t){return"\\"+N[t]}),n&&(s+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),i&&(s+="'+\n((__t=("+i+"))==null?'':__t)+\n'"),r&&(s+="';\n"+r+"\n__p+='"),a=o+e.length,e}),s+="';\n",n.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{i=new Function(n.variable||"obj","_",s)}catch(o){throw o.source=s,o}if(e)return i(e,$);var l=function(t){return i.call(this,t,$)};return l.source="function("+(n.variable||"obj")+"){\n"+s+"}",l},$.chain=function(t){return $(t).chain()};var z=function(t){return this._chain?$(t).chain():t};$.mixin($),S(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=i[t];$.prototype[t]=function(){var n=this._wrapped;return e.apply(n,arguments),"shift"!=t&&"splice"!=t||0!==n.length||delete n[0],z.call(this,n)}}),S(["concat","join","slice"],function(t){var e=i[t];$.prototype[t]=function(){return z.call(this,e.apply(this._wrapped,arguments))}}),$.extend($.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof define&&define.amd&&define("underscore",[],function(){return $})}.call(this),function(t,e){"undefined"!=typeof exports?e(t,exports,require("underscore")):"function"==typeof define&&define.amd?define("backbone",["underscore","jquery","exports"],function(n,i,r){t.Backbone=e(t,r,n,i)}):t.Backbone=e(t,{},t._,t.jQuery||t.Zepto||t.ender||t.$)}(this,function(t,e,n,i){{var r=t.Backbone,a=[],s=(a.push,a.slice);a.splice}e.VERSION="1.1.0",e.$=i,e.noConflict=function(){return t.Backbone=r,this},e.emulateHTTP=!1,e.emulateJSON=!1;var o=e.Events={on:function(t,e,n){if(!u(this,"on",t,[e,n])||!e)return this;this._events||(this._events={});var i=this._events[t]||(this._events[t]=[]);return i.push({callback:e,context:n,ctx:n||this}),this},once:function(t,e,i){if(!u(this,"once",t,[e,i])||!e)return this;var r=this,a=n.once(function(){r.off(t,a),e.apply(this,arguments)});return a._callback=e,this.on(t,a,i)},off:function(t,e,i){var r,a,s,o,l,c,h,d;if(!this._events||!u(this,"off",t,[e,i]))return this;if(!t&&!e&&!i)return this._events={},this;for(o=t?[t]:n.keys(this._events),l=0,c=o.length;c>l;l++)if(t=o[l],s=this._events[t]){if(this._events[t]=r=[],e||i)for(h=0,d=s.length;d>h;h++)a=s[h],(e&&e!==a.callback&&e!==a.callback._callback||i&&i!==a.context)&&r.push(a);r.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=s.call(arguments,1);if(!u(this,"trigger",t,e))return this;var n=this._events[t],i=this._events.all;return n&&c(n,e),i&&c(i,arguments),this},stopListening:function(t,e,i){var r=this._listeningTo;if(!r)return this;var a=!e&&!i;i||"object"!=typeof e||(i=this),t&&((r={})[t._listenId]=t);for(var s in r)t=r[s],t.off(e,i,this),(a||n.isEmpty(t._events))&&delete this._listeningTo[s];return this}},l=/\s+/,u=function(t,e,n,i){if(!n)return!0;if("object"==typeof n){for(var r in n)t[e].apply(t,[r,n[r]].concat(i));return!1}if(l.test(n)){for(var a=n.split(l),s=0,o=a.length;o>s;s++)t[e].apply(t,[a[s]].concat(i));return!1}return!0},c=function(t,e){var n,i=-1,r=t.length,a=e[0],s=e[1],o=e[2];switch(e.length){case 0:for(;++i<r;)(n=t[i]).callback.call(n.ctx);return;case 1:for(;++i<r;)(n=t[i]).callback.call(n.ctx,a);return;case 2:for(;++i<r;)(n=t[i]).callback.call(n.ctx,a,s);return;case 3:for(;++i<r;)(n=t[i]).callback.call(n.ctx,a,s,o);return;default:for(;++i<r;)(n=t[i]).callback.apply(n.ctx,e)}},h={listenTo:"on",listenToOnce:"once"};n.each(h,function(t,e){o[e]=function(e,i,r){var a=this._listeningTo||(this._listeningTo={}),s=e._listenId||(e._listenId=n.uniqueId("l"));return a[s]=e,r||"object"!=typeof i||(r=this),e[t](i,r,this),this}}),o.bind=o.on,o.unbind=o.off,n.extend(e,o);var d=e.Model=function(t,e){var i=t||{};e||(e={}),this.cid=n.uniqueId("c"),this.attributes={},e.collection&&(this.collection=e.collection),e.parse&&(i=this.parse(i,e)||{}),i=n.defaults({},i,n.result(this,"defaults")),this.set(i,e),this.changed={},this.initialize.apply(this,arguments)};n.extend(d.prototype,o,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(){return n.clone(this.attributes)},sync:function(){return e.sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(t){return n.escape(this.get(t))},has:function(t){return null!=this.get(t)},set:function(t,e,i){var r,a,s,o,l,u,c,h;if(null==t)return this;if("object"==typeof t?(a=t,i=e):(a={})[t]=e,i||(i={}),!this._validate(a,i))return!1;s=i.unset,l=i.silent,o=[],u=this._changing,this._changing=!0,u||(this._previousAttributes=n.clone(this.attributes),this.changed={}),h=this.attributes,c=this._previousAttributes,this.idAttribute in a&&(this.id=a[this.idAttribute]);for(r in a)e=a[r],n.isEqual(h[r],e)||o.push(r),n.isEqual(c[r],e)?delete this.changed[r]:this.changed[r]=e,s?delete h[r]:h[r]=e;if(!l){o.length&&(this._pending=!0);for(var d=0,f=o.length;f>d;d++)this.trigger("change:"+o[d],this,h[o[d]],i)}if(u)return this;if(!l)for(;this._pending;)this._pending=!1,this.trigger("change",this,i);return this._pending=!1,this._changing=!1,this},unset:function(t,e){return this.set(t,void 0,n.extend({},e,{unset:!0}))},clear:function(t){var e={};for(var i in this.attributes)e[i]=void 0;return this.set(e,n.extend({},t,{unset:!0}))},hasChanged:function(t){return null==t?!n.isEmpty(this.changed):n.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?n.clone(this.changed):!1;var e,i=!1,r=this._changing?this._previousAttributes:this.attributes;for(var a in t)n.isEqual(r[a],e=t[a])||((i||(i={}))[a]=e);return i},previous:function(t){return null!=t&&this._previousAttributes?this._previousAttributes[t]:null},previousAttributes:function(){return n.clone(this._previousAttributes)},fetch:function(t){t=t?n.clone(t):{},void 0===t.parse&&(t.parse=!0);var e=this,i=t.success;return t.success=function(n){return e.set(e.parse(n,t),t)?(i&&i(e,n,t),void e.trigger("sync",e,n,t)):!1},R(this,t),this.sync("read",this,t)},save:function(t,e,i){var r,a,s,o=this.attributes;if(null==t||"object"==typeof t?(r=t,i=e):(r={})[t]=e,i=n.extend({validate:!0},i),r&&!i.wait){if(!this.set(r,i))return!1}else if(!this._validate(r,i))return!1;r&&i.wait&&(this.attributes=n.extend({},o,r)),void 0===i.parse&&(i.parse=!0);var l=this,u=i.success;return i.success=function(t){l.attributes=o;var e=l.parse(t,i);return i.wait&&(e=n.extend(r||{},e)),n.isObject(e)&&!l.set(e,i)?!1:(u&&u(l,t,i),void l.trigger("sync",l,t,i))},R(this,i),a=this.isNew()?"create":i.patch?"patch":"update","patch"===a&&(i.attrs=r),s=this.sync(a,this,i),r&&i.wait&&(this.attributes=o),s},destroy:function(t){t=t?n.clone(t):{};var e=this,i=t.success,r=function(){e.trigger("destroy",e,e.collection,t)};if(t.success=function(n){(t.wait||e.isNew())&&r(),i&&i(e,n,t),e.isNew()||e.trigger("sync",e,n,t)},this.isNew())return t.success(),!1;R(this,t);var a=this.sync("delete",this,t);return t.wait||r(),a},url:function(){var t=n.result(this,"urlRoot")||n.result(this.collection,"url")||N();return this.isNew()?t:t+("/"===t.charAt(t.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(t){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},isValid:function(t){return this._validate({},n.extend(t||{},{validate:!0}))},_validate:function(t,e){if(!e.validate||!this.validate)return!0;t=n.extend({},this.attributes,t);var i=this.validationError=this.validate(t,e)||null;return i?(this.trigger("invalid",this,i,n.extend(e,{validationError:i})),!1):!0}});var f=["keys","values","pairs","invert","pick","omit"];n.each(f,function(t){d.prototype[t]=function(){var e=s.call(arguments);return e.unshift(this.attributes),n[t].apply(n,e)}});var p=e.Collection=function(t,e){e||(e={}),e.model&&(this.model=e.model),void 0!==e.comparator&&(this.comparator=e.comparator),this._reset(),this.initialize.apply(this,arguments),t&&this.reset(t,n.extend({silent:!0},e))},g={add:!0,remove:!0,merge:!0},v={add:!0,remove:!1};n.extend(p.prototype,o,{model:d,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return e.sync.apply(this,arguments)},add:function(t,e){return this.set(t,n.extend({merge:!1},e,v))},remove:function(t,e){var i=!n.isArray(t);t=i?[t]:n.clone(t),e||(e={});var r,a,s,o;for(r=0,a=t.length;a>r;r++)o=t[r]=this.get(t[r]),o&&(delete this._byId[o.id],delete this._byId[o.cid],s=this.indexOf(o),this.models.splice(s,1),this.length--,e.silent||(e.index=s,o.trigger("remove",o,this,e)),this._removeReference(o));return i?t[0]:t},set:function(t,e){e=n.defaults({},e,g),e.parse&&(t=this.parse(t,e));var i=!n.isArray(t);t=i?t?[t]:[]:n.clone(t);var r,a,s,o,l,u,c,h=e.at,f=this.model,p=this.comparator&&null==h&&e.sort!==!1,v=n.isString(this.comparator)?this.comparator:null,m=[],y=[],b={},_=e.add,w=e.merge,x=e.remove,$=!p&&_&&x?[]:!1;for(r=0,a=t.length;a>r;r++){if(l=t[r],s=l instanceof d?o=l:l[f.prototype.idAttribute],u=this.get(s))x&&(b[u.cid]=!0),w&&(l=l===o?o.attributes:l,e.parse&&(l=u.parse(l,e)),u.set(l,e),p&&!c&&u.hasChanged(v)&&(c=!0)),t[r]=u;else if(_){if(o=t[r]=this._prepareModel(l,e),!o)continue;m.push(o),o.on("all",this._onModelEvent,this),this._byId[o.cid]=o,null!=o.id&&(this._byId[o.id]=o)}$&&$.push(u||o)}if(x){for(r=0,a=this.length;a>r;++r)b[(o=this.models[r]).cid]||y.push(o);y.length&&this.remove(y,e)}if(m.length||$&&$.length)if(p&&(c=!0),this.length+=m.length,null!=h)for(r=0,a=m.length;a>r;r++)this.models.splice(h+r,0,m[r]);else{$&&(this.models.length=0);var S=$||m;for(r=0,a=S.length;a>r;r++)this.models.push(S[r])}if(c&&this.sort({silent:!0}),!e.silent){for(r=0,a=m.length;a>r;r++)(o=m[r]).trigger("add",o,this,e);(c||$&&$.length)&&this.trigger("sort",this,e)}return i?t[0]:t},reset:function(t,e){e||(e={});for(var i=0,r=this.models.length;r>i;i++)this._removeReference(this.models[i]);return e.previousModels=this.models,this._reset(),t=this.add(t,n.extend({silent:!0},e)),e.silent||this.trigger("reset",this,e),t},push:function(t,e){return this.add(t,n.extend({at:this.length},e))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t),e},unshift:function(t,e){return this.add(t,n.extend({at:0},e))},shift:function(t){var e=this.at(0);return this.remove(e,t),e},slice:function(){return s.apply(this.models,arguments)},get:function(t){return null==t?void 0:this._byId[t.id]||this._byId[t.cid]||this._byId[t]},at:function(t){return this.models[t]},where:function(t,e){return n.isEmpty(t)?e?void 0:[]:this[e?"find":"filter"](function(e){for(var n in t)if(t[n]!==e.get(n))return!1;return!0})},findWhere:function(t){return this.where(t,!0)},sort:function(t){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return t||(t={}),n.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(n.bind(this.comparator,this)),t.silent||this.trigger("sort",this,t),this},pluck:function(t){return n.invoke(this.models,"get",t)},fetch:function(t){t=t?n.clone(t):{},void 0===t.parse&&(t.parse=!0);var e=t.success,i=this;return t.success=function(n){var r=t.reset?"reset":"set";i[r](n,t),e&&e(i,n,t),i.trigger("sync",i,n,t)},R(this,t),this.sync("read",this,t)},create:function(t,e){if(e=e?n.clone(e):{},!(t=this._prepareModel(t,e)))return!1;e.wait||this.add(t,e);var i=this,r=e.success;return e.success=function(t,e,n){n.wait&&i.add(t,n),r&&r(t,e,n)},t.save(null,e),t},parse:function(t){return t},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(t,e){if(t instanceof d)return t.collection||(t.collection=this),t;e=e?n.clone(e):{},e.collection=this;var i=new this.model(t,e);return i.validationError?(this.trigger("invalid",this,i.validationError,e),!1):i},_removeReference:function(t){this===t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,n,i){("add"!==t&&"remove"!==t||n===this)&&("destroy"===t&&this.remove(e,i),e&&t==="change:"+e.idAttribute&&(delete this._byId[e.previous(e.idAttribute)],null!=e.id&&(this._byId[e.id]=e)),this.trigger.apply(this,arguments))}});var m=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain"];n.each(m,function(t){p.prototype[t]=function(){var e=s.call(arguments);return e.unshift(this.models),n[t].apply(n,e)}});var y=["groupBy","countBy","sortBy"];n.each(y,function(t){p.prototype[t]=function(e,i){var r=n.isFunction(e)?e:function(t){return t.get(e)};return n[t](this.models,r,i)}});var b=e.View=function(t){this.cid=n.uniqueId("view"),t||(t={}),n.extend(this,n.pick(t,w)),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},_=/^(\S+)\s*(.*)$/,w=["model","collection","el","id","attributes","className","tagName","events"];n.extend(b.prototype,o,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(t,n){return this.$el&&this.undelegateEvents(),this.$el=t instanceof e.$?t:e.$(t),this.el=this.$el[0],n!==!1&&this.delegateEvents(),this},delegateEvents:function(t){if(!t&&!(t=n.result(this,"events")))return this;this.undelegateEvents();for(var e in t){var i=t[e];if(n.isFunction(i)||(i=this[t[e]]),i){var r=e.match(_),a=r[1],s=r[2];i=n.bind(i,this),a+=".delegateEvents"+this.cid,""===s?this.$el.on(a,i):this.$el.on(a,s,i)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_ensureElement:function(){if(this.el)this.setElement(n.result(this,"el"),!1);else{var t=n.extend({},n.result(this,"attributes"));this.id&&(t.id=n.result(this,"id")),this.className&&(t["class"]=n.result(this,"className"));var i=e.$("<"+n.result(this,"tagName")+">").attr(t);this.setElement(i,!1)}}}),e.sync=function(t,i,r){var a=$[t];n.defaults(r||(r={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var s={type:a,dataType:"json"};if(r.url||(s.url=n.result(i,"url")||N()),null!=r.data||!i||"create"!==t&&"update"!==t&&"patch"!==t||(s.contentType="application/json",s.data=JSON.stringify(r.attrs||i.toJSON(r))),r.emulateJSON&&(s.contentType="application/x-www-form-urlencoded",s.data=s.data?{model:s.data}:{}),r.emulateHTTP&&("PUT"===a||"DELETE"===a||"PATCH"===a)){s.type="POST",r.emulateJSON&&(s.data._method=a);var o=r.beforeSend;r.beforeSend=function(t){return t.setRequestHeader("X-HTTP-Method-Override",a),o?o.apply(this,arguments):void 0}}"GET"===s.type||r.emulateJSON||(s.processData=!1),"PATCH"===s.type&&x&&(s.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var l=r.xhr=e.ajax(n.extend(s,r));return i.trigger("request",i,l,r),l};var x=!("undefined"==typeof window||!window.ActiveXObject||window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent),$={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};e.ajax=function(){return e.$.ajax.apply(e.$,arguments)};var S=e.Router=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},k=/\((.*?)\)/g,E=/(\(\?)?:\w+/g,V=/\*\w+/g,j=/[\-{}\[\]+?.,\\\^$|#\s]/g;n.extend(S.prototype,o,{initialize:function(){},route:function(t,i,r){n.isRegExp(t)||(t=this._routeToRegExp(t)),n.isFunction(i)&&(r=i,i=""),r||(r=this[i]);var a=this;return e.history.route(t,function(n){var s=a._extractParameters(t,n);r&&r.apply(a,s),a.trigger.apply(a,["route:"+i].concat(s)),a.trigger("route",i,s),e.history.trigger("route",a,i,s)}),this},navigate:function(t,n){return e.history.navigate(t,n),this},_bindRoutes:function(){if(this.routes){this.routes=n.result(this,"routes");for(var t,e=n.keys(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(j,"\\$&").replace(k,"(?:$1)?").replace(E,function(t,e){return e?t:"([^/]+)"}).replace(V,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,e){var i=t.exec(e).slice(1);return n.map(i,function(t){return t?decodeURIComponent(t):null})}});var C=e.History=function(){this.handlers=[],n.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)
},T=/^[#\/]|\s+$/g,O=/^\/+|\/+$/g,A=/msie [\w.]+/,M=/\/$/,q=/[?#].*$/;C.started=!1,n.extend(C.prototype,o,{interval:50,getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(null==t)if(this._hasPushState||!this._wantsHashChange||e){t=this.location.pathname;var n=this.root.replace(M,"");t.indexOf(n)||(t=t.slice(n.length))}else t=this.getHash();return t.replace(T,"")},start:function(t){if(C.started)throw new Error("Backbone.history has already been started");C.started=!0,this.options=n.extend({root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var i=this.getFragment(),r=document.documentMode,a=A.exec(navigator.userAgent.toLowerCase())&&(!r||7>=r);this.root=("/"+this.root+"/").replace(O,"/"),a&&this._wantsHashChange&&(this.iframe=e.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(i)),this._hasPushState?e.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!a?e.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=i;var s=this.location,o=s.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!o)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._hasPushState&&o&&s.hash&&(this.fragment=this.getHash().replace(T,""),this.history.replaceState({},document.title,this.root+this.fragment+s.search))}return this.options.silent?void 0:this.loadUrl()},stop:function(){e.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),C.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.navigate(t),void this.loadUrl())},loadUrl:function(t){return t=this.fragment=this.getFragment(t),n.any(this.handlers,function(e){return e.route.test(t)?(e.callback(t),!0):void 0})},navigate:function(t,e){if(!C.started)return!1;e&&e!==!0||(e={trigger:!!e});var n=this.root+(t=this.getFragment(t||""));if(t=t.replace(q,""),this.fragment!==t){if(this.fragment=t,""===t&&"/"!==n&&(n=n.slice(0,-1)),this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}return e.trigger?this.loadUrl(t):void 0}},_updateHash:function(t,e,n){if(n){var i=t.href.replace(/(javascript:|#).*$/,"");t.replace(i+"#"+e)}else t.hash="#"+e}}),e.history=new C;var I=function(t,e){var i,r=this;i=t&&n.has(t,"constructor")?t.constructor:function(){return r.apply(this,arguments)},n.extend(i,r,e);var a=function(){this.constructor=i};return a.prototype=r.prototype,i.prototype=new a,t&&n.extend(i.prototype,t),i.__super__=r.prototype,i};d.extend=p.extend=S.extend=b.extend=C.extend=I;var N=function(){throw new Error('A "url" property or function must be specified')},R=function(t,e){var n=e.error;e.error=function(i){n&&n(t,i,e),t.trigger("error",t,i,e)}};return e}),define("ultraform/views/form",["backbone"],function(t){var e=t.View.extend({initialize:function(){var t=this;this.$el.addClass("ufo-unchanged ufo-valid"),this.listenTo(this.model,"change:changeState",function(e){var n=e.get("changeState");this.$el.toggleClass("ufo-changed","changed"==n),this.$el.toggleClass("ufo-unchanged","unchanged"==n),t.$el.trigger({type:"ufo_"+n,$element:t.$el,change:"changed"==t.model.get("changeState"),valid:"valid"==t.model.get("validationState"),errors:t.model.get("validationErrors")})}),this.listenTo(this.model,"change:validationState",function(e){var n=e.get("validationState");this.$el.toggleClass("ufo-valid","valid"==n),this.$el.toggleClass("ufo-invalid","invalid"==n),t.$el.trigger({type:"ufo_"+n,$element:t.$el,change:"changed"==t.model.get("changeState"),valid:"valid"==t.model.get("validationState"),errors:t.model.get("validationErrors")})}),this.listenTo(this.model,"ready",function(){t.$el.trigger("ufo-ready")})}});return e}),define("ultraform/views/option",["jquery","underscore","backbone"],function(t,e,n){var i=n.View.extend({initialize:function(t){this.options=t,this.$input=this.$elFind(this.$el,'option, input[type="radio"], input[type="checkbox"]'),this.input=this.$input.get(0)},$elFind:function(t,e){return t.is(e)?t:t.find(e)},getValue:function(){return this.$input.is(":checked")?this.$input.val():null},updateModel:function(){this.options.elementView.updateModel.call(this.options.elementView)}});return i}),define("ultraform/views/element",["jquery","underscore","backbone","ultraform/views/option"],function(t,e,n,i){var r=document.createElement("div");r.innerHTML="<!--[if IE 8]>x<![endif]-->";var a="x"===r.innerHTML,s=n.View.extend({initialize:function(n){this.options=n;var r=this;this.optionViews=e.sortBy(e.map(this.options.options,function(n,a){var s=r.model.attributes.value||[],o=e.isArray(s)?-1!==e.indexOf(s,a):s==a,l=r.options.selector+"-"+a+", "+r.options.selector+' option[value="'+a+'"]',u=t(l),c=new i({elementView:r,el:u,checked:o,value:a});return c}),function(t){return t.checked}),this.$input=this.$elFind(this.$el,"input, select, textarea"),this.input=this.$input.get(0);var a=this.model.attributes.value,s=this.getValue();if(0===this.optionViews.length)null===a||"undefined"==typeof a?this.model.set("value",s):""===s?this.$elFind(this.$el,"input, select, textarea").val(a):a!=s&&console.error(this.model.id+": The DOM and the API show a different initial value!!",{modelValue:a,DOMValue:s});else{var o=e.isArray(a)?a:[a+""];null===a||"undefined"==typeof a?this.model.set("value",s):0===s.length?e.each(this.optionViews,function(t){-1!==e.indexOf(o,t.options.value)&&t.$el.prop("checked",!0)}):e.isEqual(s.sort(),o.sort())||console.error(this.model.id+": The DOM and the API show a different initial value!!",{modelValue:a,DOMValue:s}),this.$elFind(this.$el,"select").length>0&&0===this.getValue().length&&this.model.attributes.placeholder}(this.$input.is("select")||this.$input.find("select").length>0)&&(this.listenTo(this.model,"change",this.checkSelectRequired),this.checkSelectRequired()),this.listenTo(this.model,"change:value",function(t,e){r.$el.trigger("changed.el.ufo",{$element:r.$el,$input:r.$input,newValue:e,oldValue:t.get("oldValue"),label:t.get("label")})}),this.listenTo(this.model,"change:validationError change:validationSilency",function(t,e){var n=t.get("validationState");this.$el.toggleClass("error ufo-invalid","invalid"==n),this.$el.toggleClass("success ufo-valid","valid"==n),this.$el.toggleClass("ufo-pending","pending"==n),r.$el.trigger(n+".el.ufo",{$element:r.$el,$input:r.$input,newValue:t.get("value"),oldValue:t.get("oldValue"),error:"valid"==n?"":e,label:t.get("label")})}),this.listenTo(this.model,"change:changeState",function(t){var e=t.get("changeState");this.$el.toggleClass("ufo-changed","changed"==e),this.$el.toggleClass("ufo-unchanged","unchanged"==e),r.$el.trigger(e+".el.ufo",{$element:r.$el,$input:r.$input,newValue:t.get("value"),oldValue:t.get("oldValue"),label:t.get("label")})});var l=this.model.parentModel.get("settings").validate_on;if(this.$input.is("select")&&(u=this.input===this.el?"":" select",this.events={},this.events["change"+u]="updateModel",this.events[l+u]="updateModel","keyup"!==l&&(this.events["keyup"+u]="updateModelSilent"),this.delegateEvents()),this.optionViews.length>0)e.each(this.optionViews,function(t){var e=t.input===t.el?"":" input,textarea";t.events={},t.events["change"+e]="updateModel",t.delegateEvents()});else{var u=this.input===this.el?"":" input,textarea";this.events={},this.events["keypress"+u]="handleKey",this.events[l+u]="updateModel","keyup"!==l&&(this.events["keyup"+u]="updateModelSilent"),this.delegateEvents()}},$elFind:function(t,e){return t.is(e)?t:t.find(e)},events:{},checkSelectRequired:function(){var t=this.model.getRules(),n=e.where(t,{name:"required"}),i=!1;n.length>0&&this.model.parentModel.get("settings").remove_empty&&(i=!0);var r,s=this.$el.find('option[value=""]'),o=this.$el.find("select"),l=this.model.get("value");if(l&&l.length>0)r=o.data("ufoOriginalColor"),r&&o.css("color",o.data("ufoOriginalColor")),o.removeClass("hint"),i?e.each(this.emptyOptions,function(t){t.remove()}):s.data("ufoOriginalDisplay")&&(s.css("display",s.data("ufoOriginalDisplay")),s.text(""));else{r=o.css("color"),s.addClass("hint").text(this.model.attributes.placeholder),o.addClass("hint");var u=o.css("color");r==u&&(o.data("ufoOriginalColor")||o.data("ufoOriginalColor",r),o.css("color","#bbb"),s.data("ufoOriginalDisplay")||s.data("ufoOriginalDisplay",s.css("display")),s.css("display","none"),s.text(a?"":this.model.attributes.placeholder))}},getValue:function(){if(0===this.optionViews.length)return this.$input.val();var t=[];return e.each(this.optionViews,function(e){var n=e.getValue();n&&t.push(n)}),t},handleKey:function(e){var n=this.model.getRules(),i=this,r=t(e.target).val();t.each(n,function(t,n){if(n.name in i.keyHandlers){var a=i.keyHandlers[n.name](r,n.args,e);a!==!0&&(e.preventDefault(),i.insertTextAtCursor(a))}})},keyHandlers:{max_length:function(t,e,n){return t.length<e[0]||n.which<32||""},numeric:function(t,e,n){return","!==String.fromCharCode(n.which)||"."},is_numeric:function(t,e,n){return","!==String.fromCharCode(n.which)||"."},decimal:function(t,e,n){return","!==String.fromCharCode(n.which)||"."}},insertTextAtCursor:function(t){if(document.selection)this.$input.focus(),sel=document.selection.createRange(),sel.text=t;else if(this.input.selectionStart||"0"==this.input.selectionStart){var e=this.input.selectionStart,n=this.input.selectionEnd;this.input.value=this.input.value.substring(0,e)+t+this.input.value.substring(n,this.input.value.length),this.input.selectionStart=e+t.length,this.input.selectionEnd=e+t.length}else this.$input.value+=t},updateModel:function(){this.model.setValueAndValidate(this.getValue())},updateModelSilent:function(){this.model.setValueAndValidate(this.getValue(),!0)}});return s}),define("ultraform/views/elementError",["jquery","underscore","backbone"],function(t,e,n){var i=n.View.extend({initialize:function(t,e){this.setElement(e.$el),this.listenTo(this.model,"change:validationError",this.onValidation),this.listenTo(this.model,"change:validationSilency",this.onValidation)},onValidation:function(t){"valid"==t.get("validationState")?this.onValid(t):"invalid"==t.get("validationState")?this.onInvalid(t):"pending"==t.get("validationState")&&this.onValidationPending(t)},onValid:function(){this.$el.fadeOut()},onInvalid:function(t){this.$el.text(t.get("validationError")),this.$el.fadeIn()},onValidationPending:function(){}});return i}),define("ultraform/models/element",["jquery","underscore","backbone","ultraform/views/element","ultraform/views/elementError"],function(t,e,n,i,r){var a=n.Model.extend({initialize:function(e,n){var a=this;this.parentModel=n.parentModel,this.set({id:this.parentModel.get("domid")+"-"+e.name,validationState:"unknown",validationError:"unknown",validationSilency:"silent",changeState:"unchanged",oldValue:this.get("value")},{silent:!0});var s="#"+this.id,o=t(s),l=new i({model:this,options:e.options||{},selector:s,el:o}),u=t("#"+this.id+"_error"),c=t("#"+this.parentModel.get("domid"));0===u.length&&0===c.length&&(u=t('<span id="'+this.id+'_error"></span>').insertAfter(l.$el));var h;return u.length>0&&(h=new r({model:this},{$el:u})),this.initializeValidations.call(this,o),this.parentModel.listenTo(this,"change:validationError",this.parentModel.updateState),this.parentModel.listenTo(this,"change:changeState",this.parentModel.updateState),this.listenTo(this.parentModel,"ready",function(){a.validate(a.attributes,!0)}),{view:l,elementErrorView:h}},serialize:function(t){return e.isArray(t)?t.sort().join(","):t},setValueAndValidate:function(t,e){this.set({value:t,oldValue:this.get("value"),changeState:"changed"==this.get("changeState")||t!=this.get("value")?"changed":"unchanged"}),this.validate(this.attributes,e)},pendingValidations:t.when(""),_pendingValidations:[],isValid:function(){return"valid"===this.validationState},getRules:function(){var n="|",i="[",r=",",a="]",s=this.get("rules"),o=null===s?[""]:s.split(n);return t.map(o,function(t){var n=t.split(i)[0],s=e.indexOf(t,i),o=e.lastIndexOf(t,a),l=-1==s?[]:t.slice(s+1,o).split(r);return{name:n,args:l,rule:t}})},validate:function(e,n){null==n&&(n=!1);var i=this.serialize(e.value),r=this.getRules(),a=this;t.each(this._pendingValidations,function(t,e){e.reject()}),this._pendingValidations=[],t.each(r,function(r,s){if(s.name in a.validations){var o=a.validations[s.name].call(a,i,s,a);if(o===!1){var l;l=a.parentModel.attributes.messages?a.parentModel.attributes.messages[s.name]||"":"ERROR";var u=a.processMessage(l,e.label,s.args);a._pendingValidations.push(t.Deferred().resolve({valid:!1,error:u}))}else o===!0?a._pendingValidations.push(t.Deferred().resolve({valid:!0})):(a._pendingValidations.push(o),a.set({validationState:"pending",validationError:"pending",validationSilency:n?"silent":"non-silent"},{silent:n}))}else if("callback_"===s.name.slice(0,"callback_".length)){var c={"ufo-action":"callback","ufo-rule":s.rule,"ufo-value":i,"ufo-name":a.get("name"),"ufo-label":a.get("label")},h=new t.Deferred;t.ajax({url:location.pathname,type:"POST",data:c}).done(function(t){h.resolve(t)}),a._pendingValidations.push(h),a.set({validationState:"pending",validationError:"pending",validationSilency:n?"silent":"non-silent"},{silent:n}),a.parentModel.updateState()}}),this.pendingValidations=t.when.apply(this,this._pendingValidations),this.pendingValidations.then(function(){var e=Array.prototype.slice.call(arguments,0),i=!0,r="";t.each(e,function(t,e){return e.valid?void 0:(i=!1,r=e.error,!1)}),a.set({validationState:i?"valid":"invalid",validationError:i?"valid":r,validationSilency:n?"silent":"non-silent"},{silent:n}),a.parentModel.updateState()})},initializeValidations:function(){var e=this.getRules(),n=this;t.each(e,function(t,e){e.name in n.validationInitializations&&n.validationInitializations[e.name].call(n,e.args)})},validationInitializations:{matches:function(t){function e(t){n.listenTo(t,"change",function(){n.validate(n.attributes)})}var n=this,i=this.collection.where({name:t[0]});i.length>0?e(i[0]):this.listenTo(this.collection,"add",function(n){n.attributes.name===t[0]&&e(n)})}},preValidations:{max_length:function(t,e){return t.length>e[0]?t.slice(0,e[0]):t},numeric:function(t,e,n){return"change"===n?t.replace(/\,/g,"."):void 0},is_numeric:function(t,e,n){return"change"===n?t.replace(/\,/g,"."):void 0},decimal:function(t,e,n){return"change"===n?t.replace(/\,/g,"."):void 0}},validations:{required:function(e){return""!==t.trim(e)},regexp_match:function(t,e){e.args[0]=e.args.join(",");var n=e.args[0],i="",r=n.slice(0,1);n=n.slice(1);for(var a={i:!0,m:!0};n.length>0;){var s=n.slice(-1);if(n=n.slice(0,n.length-1),s===r)break;s in a?i+=s:alert("Invalid modifier for RegExp, Ultraform does not know what to do with "+s)}var o=new RegExp(n,i);return o.test(t)},matches:function(t,e){var n=this.collection.findWhere({name:e.args[0]}),i=this.serialize(n.attributes.value);return e.args[0]=n.attributes.label,t===i},is_unique:function(e,n,i){var r={"ufo-action":"callback","ufo-rule":n.rule,"ufo-value":e,"ufo-name":i.get("name"),"ufo-label":i.get("label")},a=new t.Deferred;return t.ajax({url:location.pathname,type:"POST",data:r}).done(function(t){a.resolve(t)}),a},min_length:function(t,e){return t.length>=e.args[0]},max_length:function(t,e){return t.length<=e.args[0]},exact_length:function(t,e){return t.length===e.args[0]},greater_than:function(t,e){return!isNaN(t)&&Number(t)>Number(e.args[0])},less_than:function(t,e){return!isNaN(t)&&Number(t)<Number(e.args[0])},alpha:function(t){return/^[a-zA-Z]+$/.test(t)},alpha_numeric:function(t){return/^[a-zA-Z0-9]+$/.test(t)},alpha_dash:function(t){return/^[a-zA-Z0-9_-]+$/.test(t)},numeric:function(t){return/^[\-+]?[0-9]*\.?[0-9]+$/.test(t)},is_numeric:function(t){return!isNaN(t)},integer:function(t){return/^[\-+]?[0-9]+$/.test(t)},decimal:function(t){return/^[\-+]?[0-9]+\.[0-9]+$/.test(t)},is_natural:function(t){return/^[0-9]+$/.test(t)},is_natural_no_zero:function(t){return 0===parseInt(t,10)?!1:/^[0-9]+$/.test(t)},valid_email:function(e){return/^([a-zA-Z0-9\+_\-]+)(\.[a-zA-Z0-9\+_\-]+)*@([a-zA-Z0-9\-]+\.)+[a-zA-Z]{2,6}$/.test(t.trim(e))},valid_emails:function(e){var n=this,i=e.split(","),r=!0;return t.each(i,function(e,i){return n.validations.valid_email(t.trim(i))?void 0:(r=!1,!1)}),r}},processMessage:function(e,n,i){return e=e.replace("%s",n),t.each(i,function(t,n){e=e.replace("%s",n)}),e}});return a}),define("ultraform/collections/element",["backbone","ultraform/models/element"],function(t,e){var n=t.Collection.extend({model:e});return n}),define("ultraform/views/submitButton",["backbone"],function(t){var e=t.View.extend({constructor:function(){t.View.apply(this,arguments),this.$el.addClass("ufo-disabled disabled").removeClass("ufo-enabled enabled")},initialize:function(){var t=this;this.listenToOnce(this.model.parentModel,"ready",function(){t.checkState.call(t),t.listenTo(t.model,"change",t.checkState)}),this.$el.click(function(e){t.$el.hasClass("ufo-disabled")&&e.preventDefault()})},checkState:function(){{var t=this.model.get("changeState"),e=this.model.get("validationState"),n=this.model.get("validationErrors"),i=this.$el,r=this.model.parentModel.get("settings");i.css("color")}if(i.removeClass("ufo-valid ufo-invalid ufo-changed ufo-unchanged ufo-pending ufo-disabled disabled ufo-enabled enabled"),i.addClass("ufo-"+t),i.addClass("ufo-"+e),r.disable_submit)if("valid"==e&&"changed"==t)this.$el.removeClass(r.use_disabled_class?"ufo-disabled disabled":"ufo-disabled").addClass(r.use_disabled_class?"ufo-enabled enabled":"ufo-enabled"),r.submit_set_title&&this.$el.prop("title","");else if(this.$el.addClass(r.use_disabled_class?"ufo-disabled disabled":"ufo-disabled").removeClass(r.use_disabled_class?"ufo-enabled enabled":"ufo-enabled"),r.submit_set_title){var a=r.submit_title_text;"unchanged"==t?a+="\n - "+r.submit_title_nochange:_.forEach(n,function(t){a+="\n - "+t}),this.$el.prop("title",a)}}});return e}),define("ultraform/models/submitButton",["jquery","underscore","backbone","ultraform/views/submitButton"],function(t,e,n,i){var r=n.Model.extend({initialize:function(t){var e=this;this.set({validationState:"invalid",changeState:"unchanged"},{silent:!0}),this.parentModel=t.parentModel;new i({model:this,el:t.el});this.listenTo(this.parentModel,"change",function(t){e.set({changeState:t.get("changeState"),validationState:t.get("validationState"),validationErrors:t.get("validationErrors")})})}});return r}),define("ultraform/collections/submitButton",["backbone","ultraform/models/submitButton"],function(t,e){var n=t.Collection.extend({model:e});return n}),define("ultraform/views/error",["jquery","underscore","backbone"],function(t,e,n){var i=n.View.extend({initialize:function(n,i){this.parentView=i.parentView,this.template=i.template,this.setElement(t(e.template(this.template,{message:""}))),this.$el.hide(),i.$attach.append(this.$el),this.listenTo(this.model,"change:validationError",this.onValidation)},onValidation:function(t){"valid"==t.get("validationState")?this.onValid(t):"invalid"==t.get("validationState")?this.onInvalid(t):"pending"==t.get("validationState")&&this.onValidationPending(t)},onValid:function(){this.$el.slideUp()},onInvalid:function(n){var i=this.el;this.setElement(t(e.template(this.template,{message:n.get("validationError")}))),0===this.parentView.model.get("invalidCount")||t(i).is(":hidden")&&this.$el.hide(),t(i).replaceWith(this.$el),this.$el.slideDown()},onValidationPending:function(){}});return i}),define("ultraform/views/errorBlock",["jquery","underscore","backbone","ultraform/views/error"],function(t,e,n,i){var r=n.View.extend({initialize:function(){function t(t){new i({model:t},{template:e,parentView:this,$attach:n})}this.$el.hide(),this.$ul=this.$el.find("ul"),this.ul=this.$el.get(0);var e,n;this.$ul.length>0?(e="<li><%=message%></li>",n=this.$ul):(e="<div><%=message%></div>",n=this.$el),this.model.elementCollection.forEach(t),this.listenTo(this.model.elementCollection,"add",t),this.listenTo(this.model,"change:invalidCount",this.updateValidation)},updateValidation:function(t){"invalid"==t.get("validationState")?this.$el.slideDown().fadeIn():this.$el.slideUp().fadeOut()}});return r}),define("ultraform/models/form",["jquery","underscore","backbone","ultraform/views/form","ultraform/collections/element","ultraform/collections/submitButton","ultraform/views/errorBlock"],function(t,e,n,i,r,a,s){var o=n.Model.extend({initialize:function(n){var o=this;o.markedChanged=!1,o.markedValid=!1;var l=new i({model:this,el:t("#"+n.domid)});this.elementCollection=new r;var u=l.$el.find('input[type="submit"], button[type="submit"]');this.submitButtonCollection=new a(e.map(u,function(t){return{parentModel:o,el:t,state:"unchanged-invalid"}}));var c=new s({model:this,el:t("#"+n.domid+"_error")});return t.ajax({type:"POST",data:{"ufo-action":"json","ufo-form":n.name,"ufo-id":n.id},success:function(t,e,n){var i=n.getResponseHeader("content-type")||"";o.parse(-1==i.indexOf("json")?JSON.parse(t):t)},error:function(){console.error("the model "+this.cid+" could not be loaded")}}),this.set({changeState:"unchanged",validationState:"valid",invalidCount:0},{silent:!0}),{view:l,errorView:c}},defaults:{settings:{validate_on:"blur",remove_empty:!1,disable_submit:!0,use_disabled_class:!1,submit_set_title:!0,submit_title_text:"You cannot save because",submit_title_nochange:"there are no changes to save",allow_save_on_nochange:!1}},url:location.pathname,parse:function(t){this.set("messages",t.messages||{}),this.set({settings:e.extend(this.get("settings"),t.config)}),this.get("settings").allow_save_on_nochange&&this.set({markChanged:!0});var n=this.submitButtonCollection.map(function(t){return t.get("el").name}),i=e.filter(t.elements,function(t){return!e.contains(n,t.name)});this.elementCollection.add(i,{parentModel:this}),this.trigger("ready")},updateState:function(){var t=this,n=this.elementCollection.where({validationState:"invalid"}),i=n.length,r={invalidCount:i,validationErrors:n.map(function(t){return t.get("validationError")})};r.validationState=t.markedValid?"valid":i>0?"invalid":this.elementCollection.findWhere({validationState:"pending"})?"pending":"valid";var a=this.elementCollection.where({changeState:"changed"}).length;r.changeState=t.markedChanged?"changed":a>0||t.get("settings").allow_save_on_nochange?"changed":"unchanged",e.defer(function(){t.set(r)})},markValid:function(t){null==t&&(t=!0),this.markedValid=t,this.updateState()},markChanged:function(t){null==t&&(t=!0),this.markedChanged=t,this.updateState()}});return o}),define("ultraform/collections/form",["backbone","ultraform/models/form"],function(t,e){var n=t.Collection.extend({model:e});return n}),require.config({baseUrl:"scripts",map:{"*":{jquery:"jquery/jquery-private"}},paths:{underscore:"underscore-amd/underscore",backbone:"backbone-amd/backbone",ultraform:"ultraform",almond:"almond/almond",require:"require/require"},name:"ultraform/ultraform"}),require(["jquery","underscore","backbone","ultraform/collections/form"],function(t,e,n,i){t(document).ready(function(){var e=t('form[id^="ufo-"]').map(function(){var t=this.id.split("-");return{domid:this.id,id:t.length<3?t[1]:t[2],name:t[1]}}).get();window.ufo_formcollection=new i(e)})}),define("ultraform/ultraform",function(){});